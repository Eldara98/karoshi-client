#!/bin/bash

flagsDir="/opt/karoshi/linuxclientsetup/flags"

flags=( networkset domainset passwordset nokaroshi forcesetpdc no_idle_shutdown )
flagsCanonical=( "Network Set" "Domain Set" "Password Set" "No Karoshi" "Force Set PDC" "No Idle Shutdown" )

function checkFlag {
	if [ -f "$flagsDir"/$1 ]; then eval $1=true; else eval $1=false; fi
}
function setFlag {
	if ${!1}; then
		touch "$flagsDir"/$1
	else
		[ -f "$flagsDir"/$1 ] && rm -f "$flagsDir"/$1
	fi
}

while true; do
	command=(  )
	counter=0
	
	# check flags and create command
	for flag in "${flags[@]}"; do
		checkFlag $flag
		command+=( "--field=${flagsCanonical[$counter]}:CHK" "${!flag}" )
		(( ++counter ))
	done

	data=`yad --image="/opt/karoshi/linuxclientsetup/images/smalllogo.xpm" --window-icon="/opt/karoshi/linuxclientsetup/images/smalllogo.xpm" --width=400 \
	          --title="Karoshi Flag Configuration" --button="gtk-ok" --button="gtk-cancel" --button="gtk-revert-to-saved" \
	          --form "${command[@]}"`
	yadstatus=$?
	[ $yadstatus -eq 1 ] && exit
	[ $yadstatus -eq 2 ] && continue
	
	# decypher DATA and set flags
	counter=1
	for flag in "${flags[@]}"; do
		eval $flag=`cut -d"|" -f$counter <<< "$data" | tr '[:upper:]' '[:lower:]'`
		setFlag $flag
		(( ++COUNTER ))
	done
	
	# break out of the while loop
	break
done
