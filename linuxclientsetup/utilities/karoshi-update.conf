# Karoshi Update
#
# This task pulls down new configuration files from a Karoshi server,
# to provide dynamic client updates.

description "Karoshi Configuration"
author      "Robin McCorkell <rmccorkell@karoshi.org.uk>"

start on (starting lightdm)

console log
task

pre-start script
	if [ ! -f /opt/karoshi/variables ] || ! karoshi-manage-flags get domainset >/dev/null; then
		stop
		exit 0
	fi
	
	echo
	echo "########################################"
	echo
	echo Booting on `date`
end script

script
	. /opt/karoshi/variables
	#Check if version has been set
	if [ -z "$LINUX_VERSION" ]; then
		echo Linux version not set
		LINUX_VERSION=notset
	fi

	#Make sure that netlogon share is not connected
	[ `mount | grep -c /tmp/netlogon` -gt 0 ] && umount /tmp/netlogon

	if [ ! -d /tmp/netlogon ]; then
		echo Creating netlogon folder
		mkdir /tmp/netlogon
	fi

	#Connect to the PDC to update the startup scripts
	echo Connecting to $PDC
	mount.cifs //"$PDC"/netlogon /tmp/netlogon -o guest,nounix 1>/dev/null

	#Update scripts from the server
	if [ -d /tmp/netlogon/linuxclient/$LINUX_VERSION/scripts/ ]; then
		find /tmp/netlogon/linuxclient/$LINUX_VERSION/scripts -mindepth 1 -maxdepth 1 -print0 | xargs -0 cp -rf -t /opt/karoshi/scripts
		find /opt/karoshi/scripts -mindepth 1 -print0 | xargs -0 chmod 755
	fi
	
	#Run client config
	[ -f /opt/karoshi/scripts/client-config ] && /opt/karoshi/scripts/client-config

	#Disconnect from $PDC
	echo Disconnecting from $PDC
	umount /tmp/netlogon
	
	#Restart winbind or nslcd, so they read the new configuration
	if [ "$DOMAINTYPE" = samba3 ]; then
		service winbind restart
	elif [ "$DOMAINTYPE" = samba4 ]; then
		service nslcd restart
	fi
end script

